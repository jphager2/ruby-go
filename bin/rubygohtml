#!/usr/bin/env ruby

require 'ruby-go'
require 'ruby-go/printers/html'

File.open('go.html', 'w') do |f|
  game = RubyGo::Game.new
  printer = RubyGo::HTMLPrinter.new(f)

  Signal.trap("INT") do
    puts "\nGoodbye"
    exit 1
  end

  def prompt_for_turn(game)
    loop do
      print 'Enter "Pass" or enter coordinates x, y for move (e.g. "4, 4"): '
      ans = gets.chomp.downcase.gsub(/\s/, '')

      return if ans =~ /pass/

      return ans.split(',').collect {|c| Integer(c)} if ans =~/\d+,\d+/
    end
  end

  def update_file(io, printer, game)
    system 'clear'
    io.truncate(0)
    printer.print_game(game)
  end

  update_file(f, printer, game)

  turn = 0
  until game.passes >= 2
    begin
      if turn % 2 == 0
        #black's turn
        puts "Black's turn"
        move = prompt_for_turn(game)
        move ? game.place_black(*move) : game.black_pass
      else
        #white's turn
        puts "White's turn"
        move = prompt_for_turn(game)
        move ? game.place_white(*move) : game.white_pass
      end

      update_file(f, printer, game)

      turn += 1
    rescue RubyGo::Game::IllegalMove => e
      puts e.message
      next
    end
  end

  puts "Game over"
end
